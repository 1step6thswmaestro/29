<html>
<head>
    <title>Image Upload Form</title>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<style>
    body { padding-top: 70px; }
</style>
<body>
    <form method="post" id="files" name="files" enctype="multipart/form-data" onsubmit="return submitForm();">
        <input id="fileUpload" type="file" name="file[]" multiple />
        <br>
        <input id="name" type="text" />
        <input type="submit" value="Registration" />
    </form>
    <label>Image Files</label><br>
    <div id="image-holder"></div>
    <script>
        var host = "http://175.126.82.175:20100/"
        //first data send for already registered person
        $( document ).ready(function() {
            var formData = new FormData();
            formData.append("data", '{ }');
            $.ajax({
                url: host + "request_data",
                type: "POST",
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false   // tell jQuery not to set contentType
            }).done(function( data ) {
                //debug console
                console.log("Response Output:");
                console.log(data);

                var pars = JSON.parse(data);
                var device_ids = pars["device_ids"];
                var face = pars["faces"];
                var reg_image_holder = $("#registered-image-holder");
                //for(var i = 0; i < device_ids.length; i++) {
                for(var i = 0; i < 1; i++) {
                    $("<img />", {
                        "src": host + face[0]["thumbnail"],
                        "id": face[i]["id"]
                    }).width(150).height(150).appendTo(reg_image_holder);
                    $("<figcaption id='caption'> </figcaption>").appendTo(reg_image_holder);
                    document.getElementById("caption").innerHTML = face[i]["name"];
                }
            });
        });

        //register
        var countFiles;
        var file_list;
        var name;
        $("#name").on('change', function() {
            name = $(this)[0].value;
        })
        $("#fileUpload").on('change', function () {

            //Get count of selected files
            var imgPath = $(this)[0].value;
            var extn = imgPath.substring(imgPath.lastIndexOf('.') + 1).toLowerCase();
            var image_holder = $("#image-holder");

            countFiles = $(this)[0].files.length;
            file_list = new Array(countFiles);

            image_holder.empty();

            if (extn == "gif" || extn == "png" || extn == "jpg" || extn == "jpeg") {
                if (typeof (FileReader) != "undefined") {
                    //loop for each file selected for uploaded.
                    for (var i = 0; i < countFiles; i++) {

                        var reader = new FileReader();
                        reader.onload = function (e) {
                            $("<img />", {
                                "src": e.target.result,
                                    "class": "thumb-image"
                            }).width(150).height(150).appendTo(image_holder);
                        }
                        image_holder.show();
                        reader.readAsDataURL($(this)[0].files[i]);
                    }

                } else {
                    alert("This browser does not support FileReader.");
                }
            } else {
                alert("Pls select only images");
            }
        });
    </script>

    <div id="registered-image-holder">
        <br>
        <h1>Registered Person</h1>
    </div>
    <script>
        function submitForm() {
            console.log("submit event");
            var fd = new FormData(document.getElementById("files"));
            var dic = '{ "name" : "' + name +'" }';
            fd.append("data", dic);

            $.ajax({
              url: host + "request_register_face",
              type: "POST",
              data: fd,
              enctype: 'multipart/form-data',
              processData: false,  // tell jQuery not to process the data
              contentType: false   // tell jQuery not to set contentType
            }).done(function( data ) {
                //debug console
                console.log("Response Output:");
                console.log(data);
                var pars = JSON.parse(data);
                if(pars["face"] != null) {
                    var face = pars["face"];
                    var reg_image_holder = $("#registered-image-holder");
                    $("<img />", {
                        "src": host + face["thumbnail"],
                        "id": face["id"],
                        "name": face["name"]
                    }).width(150).height(150).appendTo(reg_image_holder);

                } else {
                    alert("Does Not exist the face");
                }
            });
            return false;
        }
    </script>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid" style="font-size: 200%">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-2">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/" style="font-size: 120%"> TEAM OLD BOY </a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/wanted"> 범죄자찾기 </a></li>
            <li><a href="/lostchild"> 미아찾기 </a></li>
            <li><a href="/customer"> 손님인식 </a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            {% for pic in pictures %}
            <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12">
                <div class="panel panel-info" style="font-size: 150%">
                    <div id="" class="panel-heading text-center">
                    this is heading <b>{{pic.name}}</b>   
                    </div>
                    <div class="panel-body" style="text-align: center">
                    this is body
                    </div>
                    <div class="panel-footer" style="text-align: center">
                    this is footer
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</body>
</html>